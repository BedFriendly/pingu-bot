name: Railway 배포 파이프라인

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: '20'

jobs:
  # ============================================
  # Job 1: 린트 및 테스트
  # ============================================
  test:
    name: 린트 & 빌드 테스트
    runs-on: ubuntu-latest
    steps:
      - name: 코드 체크아웃
        uses: actions/checkout@v4

      - name: Node.js 설정
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: 의존성 설치
        run: yarn install --frozen-lockfile

      - name: 린터 실행
        run: yarn lint

      # - name: 테스트 실행 (테스트 스크립트가 있다면)
      #   run: yarn test

      - name: TypeScript 빌드
        run: yarn build

      - name: 보안 감사
        run: yarn audit --level moderate
        continue-on-error: true

  # ============================================
  # Job 2: Docker 빌드 검증
  # ============================================
  build:
    name: Docker 이미지 빌드 검증
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - name: 코드 체크아웃
        uses: actions/checkout@v4

      - name: Docker Buildx 설정
        uses: docker/setup-buildx-action@v3

      - name: Docker 이미지 빌드
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: pingu-bot:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================
  # Job 3: Railway 프로덕션 배포 (main 브랜치)
  # ============================================
  deploy-production:
    name: Railway 프로덕션 배포
    needs: [test, build]
    runs-on: ubuntu-latest
    container: ghcr.io/railwayapp/cli:latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
      url: https://railway.app
    steps:
      - name: 코드 체크아웃
        uses: actions/checkout@v4

      - name: Railway 프로덕션 배포
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          railway link --project ${{ secrets.RAILWAY_PROJECT_ID }}
          railway up --detach

      - name: 배포 상태 확인
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          railway status
          echo "✅ 프로덕션 배포가 완료되었습니다!"

      - name: 배포 로그 확인 (최근 50줄)
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: railway logs --tail 50

  # ============================================
  # Job 4: Railway 스테이징 배포 (develop 브랜치)
  # ============================================
  deploy-staging:
    name: Railway 스테이징 배포
    needs: [test, build]
    runs-on: ubuntu-latest
    container: ghcr.io/railwayapp/cli:latest
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment:
      name: staging
      url: https://railway.app
    steps:
      - name: 코드 체크아웃
        uses: actions/checkout@v4

      - name: Railway 스테이징 배포
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          railway link --project ${{ secrets.RAILWAY_PROJECT_ID }}
          railway up --environment staging --detach

      - name: 배포 상태 확인
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          railway status --environment staging
          echo "✅ 스테이징 배포가 완료되었습니다!"
